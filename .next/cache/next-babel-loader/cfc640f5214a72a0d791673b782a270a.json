{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _parseInt from \"@babel/runtime-corejs2/core-js/parse-int\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nvar _jsxFileName = \"/Users/riz/Documents/edumatis-web/pages/app/screens/siswa/Kewajiban/KewajibanDetail.tsx\";\nvar __jsx = React.createElement;\nimport createRecord from \"../../../../../libs/queries/crud/createRecord\";\nimport updateRecord from \"../../../../../libs/queries/crud/updateRecord\";\nimport { getSession } from \"../../../../../libs/queries/user/getsetSession\";\nimport UIContainer from \"../../../../../libs/ui/UIContainer\";\nimport UIHead from \"../../../../../libs/ui/UIHead\";\nimport UIWebView from \"../../../../../libs/ui/UIWebView\";\nimport dayjs from 'dayjs';\nimport { toJS } from 'mobx';\nimport { observer, useObservable } from 'mobx-react-lite';\nimport React, { useEffect } from 'react';\nimport { Text, View } from \"react-native-web\";\nexport default observer(function (_ref) {\n  var navigation = _ref.navigation;\n  var data = useObservable({\n    error: '',\n    form: (navigation || {\n      getParam: function getParam() {\n        return {\n          transaksi: []\n        };\n      }\n    }).getParam('item')\n  });\n  var transaksi = {};\n\n  if (data.form.transaksi.length > 0) {\n    transaksi = data.form.transaksi[0];\n  }\n\n  useEffect(function () {\n    var req =\n    /*#__PURE__*/\n    function () {\n      var _ref2 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee() {\n        var session, nominalBeda, expired, res, params, myHeaders, response, _json, json;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return getSession();\n\n              case 2:\n                session = _context.sent;\n                nominalBeda = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && _parseInt(transaksi.detail.amount) !== _parseInt(data.form.nominal);\n                expired = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && dayjs(transaksi.detail.expiry_date).isBefore(dayjs());\n\n                if (!(!transaksi || !transaksi.detail || nominalBeda || expired)) {\n                  _context.next = 33;\n                  break;\n                }\n\n                if (!(!transaksi || !transaksi.detail)) {\n                  _context.next = 13;\n                  break;\n                }\n\n                _context.next = 9;\n                return createRecord('transaksi', {\n                  kewajiban_id: toJS(data.form.id)\n                });\n\n              case 9:\n                res = _context.sent;\n                data.form.transaksi.push({\n                  id: res\n                });\n                transaksi = data.form.transaksi[0];\n                transaksi.id = res;\n\n              case 13:\n                if (nominalBeda) {\n                  data.form.transaksi[0].detail = null;\n                }\n\n                params = {\n                  external_id: transaksi.id,\n                  payer_email: session.murid.email || \"j@edumatis.id\",\n                  description: \"\".concat(session.sekolah.nama, \" - \").concat(session.kelas.nama, \" - \").concat(session.murid.nama_murid, \" - \").concat(data.form.nama_kewajiban),\n                  amount: _parseInt(data.form.nominal) + _parseInt(session.sekolah.margin)\n                };\n                myHeaders = new Headers();\n                myHeaders.append('pragma', 'no-cache');\n                myHeaders.append('cache-control', 'no-cache');\n                _context.next = 20;\n                return fetch(\"https://backend.cap.edumatis.id/invoice\", {\n                  method: 'POST',\n                  body: _JSON$stringify(params),\n                  headers: myHeaders\n                });\n\n              case 20:\n                response = _context.sent;\n\n                if (!(response.status !== 200)) {\n                  _context.next = 27;\n                  break;\n                }\n\n                _context.next = 24;\n                return response.json();\n\n              case 24:\n                _json = _context.sent;\n                data.error = _json.message;\n                return _context.abrupt(\"return\");\n\n              case 27:\n                _context.next = 29;\n                return response.json();\n\n              case 29:\n                json = _context.sent;\n                _context.next = 32;\n                return updateRecord('transaksi', {\n                  id: transaksi.id,\n                  nominal: data.form.nominal,\n                  detail: json\n                });\n\n              case 32:\n                data.form.transaksi[0].detail = json;\n\n              case 33:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function req() {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n\n    req();\n  }, []);\n  return __jsx(UIContainer, {\n    style: {\n      backgroundColor: '#F5FAFD'\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 90\n    },\n    __self: this\n  }, __jsx(UIHead, {\n    navigation: navigation,\n    title: \"\".concat(data.form.nama_kewajiban, \" (\").concat(data.form.status, \")\"),\n    onBack: function onBack() {\n      navigation.goBack();\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 91\n    },\n    __self: this\n  }), __jsx(View, {\n    style: {\n      flex: 1,\n      alignItems: 'center',\n      justifyContent: 'center'\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 98\n    },\n    __self: this\n  }, data.error === '' && !transaksi.detail && __jsx(Text, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 106\n    },\n    __self: this\n  }, \"Membuat Invoice...\"), data.error != '' && __jsx(Text, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 108\n    },\n    __self: this\n  }, data.error), data.error === '' && transaksi.detail && !transaksi.paid && __jsx(View, {\n    style: {\n      position: 'absolute',\n      left: 0,\n      right: 0,\n      top: 0,\n      bottom: 0\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 110\n    },\n    __self: this\n  }, __jsx(UIWebView, {\n    style: {\n      flex: 1\n    },\n    source: {\n      html: \"\\n            <!DOCTYPE html>\\n            <html>\\n                <head>\\n                <meta name=\\\"viewport\\\" content=\\\" initial-scale=1\\\">\\n                </head> \\n                <body>\\n                <center style=\\\"margin:100px\\\">Memuat<br/> Instruksi Pembayaran...</center>\\n                <iframe \\n                style=\\\"position:absolute;left:0;right:0;bottom:0;top:0;\\\"\\n                width=\\\"100%\\\" height=\\\"100%\\\" src=\\\"\".concat(transaksi.detail.invoice_url, \"\\\"  frameborder=\\\"0\\\"></iframe></div> \\n            </body>\\n            </html>\")\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 119\n    },\n    __self: this\n  }))));\n});","map":{"version":3,"sources":["/Users/riz/Documents/edumatis-web/pages/app/screens/siswa/Kewajiban/KewajibanDetail.tsx"],"names":["createRecord","updateRecord","getSession","UIContainer","UIHead","UIWebView","dayjs","toJS","observer","useObservable","React","useEffect","Text","View","navigation","data","error","form","getParam","transaksi","length","req","session","nominalBeda","status","detail","amount","nominal","expired","expiry_date","isBefore","kewajiban_id","id","res","push","params","external_id","payer_email","murid","email","description","sekolah","nama","kelas","nama_murid","nama_kewajiban","margin","myHeaders","Headers","append","fetch","method","body","headers","response","json","message","backgroundColor","goBack","flex","alignItems","justifyContent","paid","position","left","right","top","bottom","html","invoice_url"],"mappings":"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","sourcesContent":["import createRecord from '@app/libs/queries/crud/createRecord';\nimport updateRecord from '@app/libs/queries/crud/updateRecord';\nimport { getSession } from '@app/libs/queries/user/getsetSession';\nimport UIContainer from '@app/libs/ui/UIContainer';\nimport UIHead from '@app/libs/ui/UIHead';\nimport UIWebView from '@app/libs/ui/UIWebView';\nimport dayjs from 'dayjs';\nimport { toJS } from 'mobx';\nimport { observer, useObservable } from 'mobx-react-lite';\nimport React, { useEffect } from 'react';\nimport { Text, View } from 'react-native';\n\nexport default observer(({ navigation }: any) => {\n  const data = useObservable({\n    error: '',\n    form: (navigation || { getParam: () => ({ transaksi: [] }) }).getParam(\n      'item'\n    )\n  });\n  let transaksi: any = {};\n  if (data.form.transaksi.length > 0) {\n    transaksi = data.form.transaksi[0];\n  }\n  useEffect(() => {\n    const req = async function() {\n      const session = await getSession();\n      const nominalBeda =\n        data.form.status === 'Belum Lunas' &&\n        transaksi &&\n        transaksi.detail &&\n        parseInt(transaksi.detail.amount) !== parseInt(data.form.nominal);\n\n      const expired =\n        data.form.status === 'Belum Lunas' &&\n        transaksi &&\n        transaksi.detail &&\n        dayjs(transaksi.detail.expiry_date).isBefore(dayjs());\n\n      if (!transaksi || !transaksi.detail || nominalBeda || expired) {\n        if (!transaksi || !transaksi.detail) {\n          let res = await createRecord('transaksi', {\n            kewajiban_id: toJS(data.form.id)\n          });\n          data.form.transaksi.push({ id: res });\n          transaksi = data.form.transaksi[0];\n          transaksi.id = res;\n        }\n\n        if (nominalBeda) {\n          data.form.transaksi[0].detail = null;\n        }\n        var params: any = {\n          external_id: transaksi.id,\n          payer_email: session.murid.email || `j@edumatis.id`,\n          description: `${session.sekolah.nama} - ${session.kelas.nama} - ${session.murid.nama_murid} - ${data.form.nama_kewajiban}`,\n          amount: parseInt(data.form.nominal) + parseInt(session.sekolah.margin)\n        };\n\n        var myHeaders = new Headers();\n        myHeaders.append('pragma', 'no-cache');\n        myHeaders.append('cache-control', 'no-cache');\n        const response: Response = await fetch(\n          `https://backend.cap.edumatis.id/invoice`,\n          {\n            method: 'POST',\n            body: JSON.stringify(params),\n            headers: myHeaders\n          }\n        );\n\n        if (response.status !== 200) {\n          const json = await response.json();\n          data.error = (json as any).message;\n          return;\n        }\n        const json = await response.json();\n        await updateRecord('transaksi', {\n          id: transaksi.id,\n          nominal: data.form.nominal,\n          detail: json\n        });\n\n        data.form.transaksi[0].detail = json;\n      }\n    };\n    req();\n  }, []);\n\n  return (\n    <UIContainer style={{ backgroundColor: '#F5FAFD' }}>\n      <UIHead\n        navigation={navigation}\n        title={`${data.form.nama_kewajiban} (${data.form.status})`}\n        onBack={() => {\n          navigation.goBack();\n        }}\n      />\n      <View\n        style={{\n          flex: 1,\n          alignItems: 'center',\n          justifyContent: 'center'\n        }}\n      >\n        {data.error === '' && !transaksi.detail && (\n          <Text>Membuat Invoice...</Text>\n        )}\n        {data.error != '' && <Text>{data.error}</Text>}\n        {data.error === '' && transaksi.detail && !transaksi.paid && (\n          <View\n            style={{\n              position: 'absolute',\n              left: 0,\n              right: 0,\n              top: 0,\n              bottom: 0\n            }}\n          >\n            <UIWebView\n              style={{ flex: 1 }}\n              source={{\n                html: `\n            <!DOCTYPE html>\n            <html>\n                <head>\n                <meta name=\"viewport\" content=\" initial-scale=1\">\n                </head> \n                <body>\n                <center style=\"margin:100px\">Memuat<br/> Instruksi Pembayaran...</center>\n                <iframe \n                style=\"position:absolute;left:0;right:0;bottom:0;top:0;\"\n                width=\"100%\" height=\"100%\" src=\"${transaksi.detail.invoice_url}\"  frameborder=\"0\"></iframe></div> \n            </body>\n            </html>`\n              }}\n            />\n          </View>\n        )}\n      </View>\n    </UIContainer>\n  );\n});\n"]},"metadata":{},"sourceType":"module"}