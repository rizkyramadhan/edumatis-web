{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _parseInt from \"@babel/runtime-corejs2/core-js/parse-int\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\nimport createRecord from \"../../../../../libs/queries/crud/createRecord\";\nimport updateRecord from \"../../../../../libs/queries/crud/updateRecord\";\nimport { getSession } from \"../../../../../libs/queries/user/getsetSession\";\nimport UIContainer from \"../../../../../libs/ui/UIContainer\";\nimport UIHead from \"../../../../../libs/ui/UIHead\";\nimport UIWebView from \"../../../../../libs/ui/UIWebView\";\nimport dayjs from 'dayjs';\nimport { toJS } from 'mobx';\nimport { observer, useObservable } from 'mobx-react-lite';\nimport React, { useEffect } from 'react';\nimport { Text, View } from \"react-native-web\";\nexport default observer(function (_ref) {\n  var navigation = _ref.navigation;\n  var data = useObservable({\n    error: '',\n    form: (navigation || {\n      getParam: function getParam() {\n        return {\n          transaksi: []\n        };\n      }\n    }).getParam('item')\n  });\n  var transaksi = {};\n\n  if (data.form.transaksi.length > 0) {\n    transaksi = data.form.transaksi[0];\n  }\n\n  useEffect(function () {\n    var req =\n    /*#__PURE__*/\n    function () {\n      var _ref2 = _asyncToGenerator(\n      /*#__PURE__*/\n      _regeneratorRuntime.mark(function _callee() {\n        var session, nominalBeda, expired, res, params, myHeaders, response, _json, json;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return getSession();\n\n              case 2:\n                session = _context.sent;\n                nominalBeda = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && _parseInt(transaksi.detail.amount) !== _parseInt(data.form.nominal);\n                expired = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && dayjs(transaksi.detail.expiry_date).isBefore(dayjs());\n\n                if (!(!transaksi || !transaksi.detail || nominalBeda || expired)) {\n                  _context.next = 33;\n                  break;\n                }\n\n                if (!(!transaksi || !transaksi.detail)) {\n                  _context.next = 13;\n                  break;\n                }\n\n                _context.next = 9;\n                return createRecord('transaksi', {\n                  kewajiban_id: toJS(data.form.id)\n                });\n\n              case 9:\n                res = _context.sent;\n                data.form.transaksi.push({\n                  id: res\n                });\n                transaksi = data.form.transaksi[0];\n                transaksi.id = res;\n\n              case 13:\n                if (nominalBeda) {\n                  data.form.transaksi[0].detail = null;\n                }\n\n                params = {\n                  external_id: transaksi.id,\n                  payer_email: session.murid.email || \"j@edumatis.id\",\n                  description: \"\".concat(session.sekolah.nama, \" - \").concat(session.kelas.nama, \" - \").concat(session.murid.nama_murid, \" - \").concat(data.form.nama_kewajiban),\n                  amount: _parseInt(data.form.nominal) + _parseInt(session.sekolah.margin)\n                };\n                myHeaders = new Headers();\n                myHeaders.append('pragma', 'no-cache');\n                myHeaders.append('cache-control', 'no-cache');\n                _context.next = 20;\n                return fetch(\"https://backend.cap.edumatis.id/invoice\", {\n                  method: 'POST',\n                  body: _JSON$stringify(params),\n                  headers: myHeaders\n                });\n\n              case 20:\n                response = _context.sent;\n\n                if (!(response.status !== 200)) {\n                  _context.next = 27;\n                  break;\n                }\n\n                _context.next = 24;\n                return response.json();\n\n              case 24:\n                _json = _context.sent;\n                data.error = _json.message;\n                return _context.abrupt(\"return\");\n\n              case 27:\n                _context.next = 29;\n                return response.json();\n\n              case 29:\n                json = _context.sent;\n                _context.next = 32;\n                return updateRecord('transaksi', {\n                  id: transaksi.id,\n                  nominal: data.form.nominal,\n                  detail: json\n                });\n\n              case 32:\n                data.form.transaksi[0].detail = json;\n\n              case 33:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n\n      return function req() {\n        return _ref2.apply(this, arguments);\n      };\n    }();\n\n    req();\n  }, []);\n  return __jsx(UIContainer, {\n    style: {\n      backgroundColor: '#F5FAFD'\n    }\n  }, __jsx(UIHead, {\n    navigation: navigation,\n    title: \"\".concat(data.form.nama_kewajiban, \" (\").concat(data.form.status, \")\"),\n    onBack: function onBack() {\n      navigation.goBack();\n    }\n  }), __jsx(View, {\n    style: {\n      flex: 1,\n      alignItems: 'center',\n      justifyContent: 'center'\n    }\n  }, data.error === '' && !transaksi.detail && __jsx(Text, null, \"Membuat Invoice...\"), data.error != '' && __jsx(Text, null, data.error), data.error === '' && transaksi.detail && !transaksi.paid && __jsx(View, {\n    style: {\n      position: 'absolute',\n      left: 0,\n      right: 0,\n      top: 0,\n      bottom: 0\n    }\n  }, __jsx(UIWebView, {\n    style: {\n      flex: 1\n    },\n    source: {\n      html: \"\\n            <!DOCTYPE html>\\n            <html>\\n                <head>\\n                <meta name=\\\"viewport\\\" content=\\\" initial-scale=1\\\">\\n                </head> \\n                <body>\\n                <center style=\\\"margin:100px\\\">Memuat<br/> Instruksi Pembayaran...</center>\\n                <iframe \\n                style=\\\"position:absolute;left:0;right:0;bottom:0;top:0;\\\"\\n                width=\\\"100%\\\" height=\\\"100%\\\" src=\\\"\".concat(transaksi.detail.invoice_url, \"\\\"  frameborder=\\\"0\\\"></iframe></div> \\n            </body>\\n            </html>\")\n    }\n  }))));\n});","map":null,"metadata":{},"sourceType":"module"}