{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport _parseInt from \"@babel/runtime-corejs2/core-js/parse-int\";\nvar __jsx = React.createElement;\nimport createRecord from \"../../../../../libs/queries/crud/createRecord\";\nimport updateRecord from \"../../../../../libs/queries/crud/updateRecord\";\nimport { getSession } from \"../../../../../libs/queries/user/getsetSession\";\nimport UIContainer from \"../../../../../libs/ui/UIContainer\";\nimport UIHead from \"../../../../../libs/ui/UIHead\";\nimport UIWebView from \"../../../../../libs/ui/UIWebView\";\nimport dayjs from 'dayjs';\nimport { toJS } from 'mobx';\nimport { observer, useObservable } from 'mobx-react-lite';\nimport React, { useEffect } from 'react';\nimport { Text, View } from \"react-native-web\";\nexport default observer(({\n  navigation\n}) => {\n  const data = useObservable({\n    error: '',\n    form: (navigation || {\n      getParam: () => ({\n        transaksi: []\n      })\n    }).getParam('item')\n  });\n  let transaksi = {};\n\n  if (data.form.transaksi.length > 0) {\n    transaksi = data.form.transaksi[0];\n  }\n\n  useEffect(() => {\n    const req = async function () {\n      const session = await getSession();\n\n      const nominalBeda = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && _parseInt(transaksi.detail.amount) !== _parseInt(data.form.nominal);\n\n      const expired = data.form.status === 'Belum Lunas' && transaksi && transaksi.detail && dayjs(transaksi.detail.expiry_date).isBefore(dayjs());\n\n      if (!transaksi || !transaksi.detail || nominalBeda || expired) {\n        if (!transaksi || !transaksi.detail) {\n          let res = await createRecord('transaksi', {\n            kewajiban_id: toJS(data.form.id)\n          });\n          data.form.transaksi.push({\n            id: res\n          });\n          transaksi = data.form.transaksi[0];\n          transaksi.id = res;\n        }\n\n        if (nominalBeda) {\n          data.form.transaksi[0].detail = null;\n        }\n\n        var params = {\n          external_id: transaksi.id,\n          payer_email: session.murid.email || `j@edumatis.id`,\n          description: `${session.sekolah.nama} - ${session.kelas.nama} - ${session.murid.nama_murid} - ${data.form.nama_kewajiban}`,\n          amount: _parseInt(data.form.nominal) + _parseInt(session.sekolah.margin)\n        };\n        var myHeaders = new Headers();\n        myHeaders.append('pragma', 'no-cache');\n        myHeaders.append('cache-control', 'no-cache');\n        const response = await fetch(`https://backend.cap.edumatis.id/invoice`, {\n          method: 'POST',\n          body: _JSON$stringify(params),\n          headers: myHeaders\n        });\n\n        if (response.status !== 200) {\n          const json = await response.json();\n          data.error = json.message;\n          return;\n        }\n\n        const json = await response.json();\n        await updateRecord('transaksi', {\n          id: transaksi.id,\n          nominal: data.form.nominal,\n          detail: json\n        });\n        data.form.transaksi[0].detail = json;\n      }\n    };\n\n    req();\n  }, []);\n  return __jsx(UIContainer, {\n    style: {\n      backgroundColor: '#F5FAFD'\n    }\n  }, __jsx(UIHead, {\n    navigation: navigation,\n    title: `${data.form.nama_kewajiban} (${data.form.status})`,\n    onBack: () => {\n      navigation.goBack();\n    }\n  }), __jsx(View, {\n    style: {\n      flex: 1,\n      alignItems: 'center',\n      justifyContent: 'center'\n    }\n  }, data.error === '' && !transaksi.detail && __jsx(Text, null, \"Membuat Invoice...\"), data.error != '' && __jsx(Text, null, data.error), data.error === '' && transaksi.detail && !transaksi.paid && __jsx(View, {\n    style: {\n      position: 'absolute',\n      left: 0,\n      right: 0,\n      top: 0,\n      bottom: 0\n    }\n  }, __jsx(UIWebView, {\n    style: {\n      flex: 1\n    },\n    source: {\n      html: `\n            <!DOCTYPE html>\n            <html>\n                <head>\n                <meta name=\"viewport\" content=\" initial-scale=1\">\n                </head> \n                <body>\n                <center style=\"margin:100px\">Memuat<br/> Instruksi Pembayaran...</center>\n                <iframe \n                style=\"position:absolute;left:0;right:0;bottom:0;top:0;\"\n                width=\"100%\" height=\"100%\" src=\"${transaksi.detail.invoice_url}\"  frameborder=\"0\"></iframe></div> \n            </body>\n            </html>`\n    }\n  }))));\n});","map":null,"metadata":{},"sourceType":"module"}